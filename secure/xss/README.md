# XSS

XSS = cross site script 区别于CSS(Cascading Style Sheet) 所以叫XSS

> XSS 攻击是指 **攻击者在网站上注入恶意的客户端代码** (这一点从 英文全名 script也能看出)，通过恶意脚本对客户端网页进行篡改，从而在用户浏览网页时，对用户浏览器进行控制或者获取用户隐私数据的一种攻击方式。

> 攻击者对客户端网页注入的恶意脚本一般包括 JavaScript，有时也会包含 HTML 和 Flash。有很多种方式进行 XSS 攻击，但它们的共同点为：将一些隐私数据像 cookie、session 发送给攻击者，将受害者重定向到一个由攻击者控制的网站，在受害者的机器上进行一些恶意操作。

XSS攻击可以分为3类：反射型（非持久型）、存储型（持久型）、DOM型。

#### 反射型
> 反射型 XSS 只是简单地把用户输入的数据 **“反射”** 给浏览器，这种攻击方式往往需要攻击者诱使用户**点击一个恶意链接，或者提交一个表单**，或者进入一个恶意网站时，注入脚本**进入攻击者的网站。**
反射型 XSS 的恶意代码存在 URL 里,而存储型的恶意代码存放在数据库里。

可以启动 app.js和app2.js文件 然后打开服务器访问http://localhost:8012并点击xss按钮
通过(伪造的)XSS注入 你可以看到然后 你可以在app2.js的终端看见 服务器成功获取了app.js

还可以看index.html的例子, 假设`"><script>alert('XSS');</script>`这一段是攻击者通过url输入的。突破了原有的位置，原本浏览器解析的是value = "文本"，然后文本中这一段就让浏览器误以为是有一个input标签以及script标签了。


那我们是不是对这些敏感的HTML文本转义就高枕无忧了呢？
但是在某些特定位置上，即使文本被转义了，也有可能出现问题，比如说a链接，文本输入一个`javascript`伪协议。


这里复习下cookie在CORS中的使用
1. 请求中得开启携带 xhr.withCredentials
2. 响应中得携带请求头 "Access-Control-Allow-Credentials" : "true"

#### 存储型
存储型 XSS 会把用户输入的数据 "存储" 在服务器端，当浏览器请求数据时，脚本从服务器上传回并执行。这种 XSS 攻击具有很强的稳定性。
比较常见的一个场景是攻击者在社区或论坛上写下一篇包含恶意 JavaScript 代码的文章或评论，文章或评论发表后，所有访问该文章或评论的用户，都会在他们的浏览器中执行这段恶意的 JavaScript 代码。


#### 基于DOM

DOM型XSS是基于DOM文档对象模型的一种漏洞。严格来说，**DOM型XSS其实算反射型XSS，区别在于DOM型XSS并不会和后台进行交互，是完完全全的web前端安全问题**，要做防御也只能在客户端上进行防御。

基于 DOM 的 XSS 攻击经常发生在Javascript从**攻击者控制的地方**取到了数据。说得更详细点就是，脚本程序可能会从dom对象中（BOM应该也被包含在里面）
例如URL、然后将其传入支持动态语句执行的sink，例如eval函数或者是innerHTML等

[XSS-game](https://xss-game.appspot.com/)
#### 解决方案

**HttpOnly 防止劫取 Cookie**
这个字段其实就是指 该字段**只能通过HTTP请求去修改，不能通过JS操作**。但是在跨域请求访问时，仍然会携带
cookie信息

**输入检查**
>  对于用户的任何输入要进行检查、过滤和转义。建立可信任的字符和 HTML 标签白名单，对于不在白名单之列的字符或者标签进行过滤或编码。

```
// vuejs 中的 decodingMap
// 在 vuejs 中，如果输入带 script 标签的内容，会直接过滤掉
const decodingMap = {
  '&lt;': '<',
  '&gt;': '>',
  '&quot;': '"',
  '&amp;': '&',
  '&#10;': '\n'
}
```

**输出检查**

用户的输入会存在问题，服务端的输出也会存在问题。一般来说，除富文本的输出外，在变量输出到 HTML 页面时，可以使用编码或转义的方式来防御 XSS 攻击。例如利用 sanitize-html 对输出内容进行有规则的过滤之后再输出到页面中。

### 如何检测

1. 使用通用XSS攻击字符串手动检测XSS漏洞

```
jaVasCript:/*-/*`/*\`/*'/*"/**/(/* */oNcliCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\x3csVg/<sVg/oNloAd=alert()//>\x3e
```

2. 使用扫描工具自动检测 XSS 漏洞。(例如w3af)